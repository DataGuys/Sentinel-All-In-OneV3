{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name for the Log Analytics workspace"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "workbookName": {
      "type": "string",
      "defaultValue": "sentinelcostcontrol",
      "metadata": {
        "description": "Name for the interactive cost monitoring workbook"
      }
    },
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Sentinel V3 Interactive Cost Optimization Dashboard",
      "metadata": {
        "description": "Display name for the interactive cost monitoring workbook"
      }
    },
    "roleGuid": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Guid for the role assignment"
      }
    }
  },
  "variables": {
    "workbookId": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookName'))]",
    "managedIdentityName": "[concat('id-', parameters('workbookName'))]",
    "contributorRoleId": "b24988ac-6180-42a0-ab88-20f7382dd24c",
    "workbookContent": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Microsoft Sentinel Interactive Cost Optimization Dashboard\\r\\n\\r\\nThis dashboard helps you monitor and optimize the costs associated with your Microsoft Sentinel deployment with a focus on tiering verbose data sources. Use the controls below to interactively manage table storage tiers and retention periods.\\r\\n\\r\\n\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"94c93e8c-b1b0-4bdf-901e-81b894c67b1d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":604800000},{\"durationMs\":2592000000}]}}],\"style\":\"pills\",\"queryType\":0},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Usage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| summarize TotalGBytes = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), Solution\\r\\n| render timechart\",\"size\":0,\"aggregation\":5,\"title\":\"Daily Ingestion Volume by Solution\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"DailyIngestionBySolution\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Usage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| summarize TotalGBytes = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), DataType\\r\\n| render timechart\",\"size\":0,\"aggregation\":5,\"title\":\"Daily Ingestion Volume by Data Type\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"DailyIngestionByDataType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Cost projection based on current usage with tiering optimization\\r\\nlet dailyAverage = Usage\\r\\n| where TimeGenerated > ago(7d)\\r\\n| where IsBillable == true\\r\\n| extend Tier = case(\\r\\n    DataType in ('SigninLogs', 'AuditLogs', 'SecurityAlert', 'SecurityIncident', 'Corelight_DNS', 'Corelight_HTTP', 'Corelight_SSL'), 'Standard',\\r\\n    DataType in ('NonInteractiveUserSignInLogs', 'ServicePrincipalSignInLogs', 'Corelight_Conn'), 'Auxiliary',\\r\\n    DataType in ('Corelight_SMB'), 'Basic',\\r\\n    'Standard'\\r\\n)\\r\\n| summarize AvgGBPerDay = sum(Quantity) / 1000 / 7 by Tier;\\r\\n\\r\\nlet optimizedDaily = Usage\\r\\n| where TimeGenerated > ago(7d)\\r\\n| where IsBillable == true\\r\\n| extend OptimizedTier = case(\\r\\n    DataType in ('SigninLogs', 'AuditLogs', 'SecurityAlert', 'SecurityIncident'), 'Standard',\\r\\n    DataType in ('NonInteractiveUserSignInLogs', 'ServicePrincipalSignInLogs', 'Corelight_DNS', 'Corelight_HTTP', 'Corelight_SSL', 'Corelight_Conn'), 'Auxiliary',\\r\\n    'Basic'\\r\\n)\\r\\n| summarize OptimizedAvgGBPerDay = sum(Quantity) / 1000 / 7 by OptimizedTier;\\r\\n\\r\\n// Summarize current tier costs\\r\\ndailyAverage\\r\\n| extend CurrentPrice = case(\\r\\n    Tier == 'Standard', 4.00,  // Sample standard tier cost - adjust to your actual pricing\\r\\n    Tier == 'Auxiliary', 1.50, // Sample auxiliary tier cost - adjust to your actual pricing\\r\\n    Tier == 'Basic', 0.50,     // Sample basic tier cost - adjust to your actual pricing\\r\\n    4.00\\r\\n)\\r\\n| extend CurrentDailyCost = AvgGBPerDay * CurrentPrice\\r\\n| extend CurrentMonthlyCost = CurrentDailyCost * 30\\r\\n| extend CurrentYearlyCost = CurrentMonthlyCost * 12\\r\\n| summarize CurrentDaily = sum(CurrentDailyCost), CurrentMonthly = sum(CurrentMonthlyCost), CurrentYearly = sum(CurrentYearlyCost)\\r\\n| join kind=inner (\\r\\n    // Summarize optimized tier costs\\r\\n    optimizedDaily\\r\\n    | extend OptimizedPrice = case(\\r\\n        OptimizedTier == 'Standard', 4.00,  // Sample standard tier cost - adjust to your actual pricing\\r\\n        OptimizedTier == 'Auxiliary', 1.50, // Sample auxiliary tier cost - adjust to your actual pricing\\r\\n        OptimizedTier == 'Basic', 0.50,     // Sample basic tier cost - adjust to your actual pricing\\r\\n        4.00\\r\\n    )\\r\\n    | extend OptimizedDailyCost = OptimizedAvgGBPerDay * OptimizedPrice\\r\\n    | extend OptimizedMonthlyCost = OptimizedDailyCost * 30\\r\\n    | extend OptimizedYearlyCost = OptimizedMonthlyCost * 12\\r\\n    | summarize OptimizedDaily = sum(OptimizedDailyCost), OptimizedMonthly = sum(OptimizedMonthlyCost), OptimizedYearly = sum(OptimizedYearlyCost)\\r\\n) on $left.CurrentDaily == $right.OptimizedDaily\\r\\n| extend PotentialMonthlySavings = CurrentMonthly - OptimizedMonthly\\r\\n| extend PotentialYearlySavings = CurrentYearly - OptimizedYearly\\r\\n| extend SavingsPercentage = ((CurrentYearly - OptimizedYearly) / CurrentYearly) * 100\\r\\n| project ['Current Monthly Cost'] = CurrentMonthly, ['Optimized Monthly Cost'] = OptimizedMonthly, ['Monthly Savings'] = PotentialMonthlySavings, ['Yearly Savings'] = PotentialYearlySavings, ['Savings Percentage'] = SavingsPercentage\",\"size\":4,\"title\":\"Cost Projection with Optimization\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"CostProjection\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Top tables by ingestion volume and their current tier settings\\r\\nUsage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| summarize TotalGB = sum(Quantity)/1000 by DataType\\r\\n| order by TotalGB desc\\r\\n| limit 20\\r\\n| join kind=leftouter (\\r\\n    workspace('${parameters('workspaceName')}').Tables\\r\\n    | where TableName != ''\\r\\n    | project TableName, Tier = iif(isempty(Tier), 'Standard', Tier), RetentionInDays\\r\\n) on $left.DataType == $right.TableName\\r\\n| extend RetentionInDays = iif(isempty(RetentionInDays), 30, RetentionInDays)\\r\\n| extend Tier = iif(isempty(Tier), 'Standard', Tier)\\r\\n| extend SecurityValue = case(\\r\\n    DataType in ('SecurityAlert', 'SecurityIncident', 'SigninLogs', 'AuditLogs', 'Corelight_DNS', 'Corelight_HTTP', 'Corelight_SSL'), 'High',\\r\\n    DataType in ('AzureActivity', 'CommonSecurityLog', 'Event', 'Corelight_Conn'), 'Medium',\\r\\n    'Low'\\r\\n)\\r\\n| extend RecommendedTier = case(\\r\\n    SecurityValue == 'High', 'Standard',\\r\\n    SecurityValue == 'Medium', 'Auxiliary',\\r\\n    'Basic'\\r\\n)\\r\\n| extend MonthlyCost = case(\\r\\n    Tier == 'Standard', TotalGB * 4.00 / 30,\\r\\n    Tier == 'Auxiliary', TotalGB * 1.50 / 30,\\r\\n    Tier == 'Basic', TotalGB * 0.50 / 30,\\r\\n    TotalGB * 4.00 / 30\\r\\n)\\r\\n| extend PotentialOptimizedCost = case(\\r\\n    RecommendedTier == 'Standard', TotalGB * 4.00 / 30,\\r\\n    RecommendedTier == 'Auxiliary', TotalGB * 1.50 / 30,\\r\\n    RecommendedTier == 'Basic', TotalGB * 0.50 / 30,\\r\\n    TotalGB * 4.00 / 30\\r\\n)\\r\\n| extend PotentialMonthlySavings = MonthlyCost - PotentialOptimizedCost\\r\\n| project TableName = DataType, ['Total GB (30d)'] = TotalGB, ['Current Tier'] = Tier, ['Current Retention'] = RetentionInDays, SecurityValue, ['Recommended Tier'] = RecommendedTier, ['Monthly Savings'] = PotentialMonthlySavings, ['Daily Cost'] = MonthlyCost\\r\\n| order by ['Total GB (30d)'] desc\",\"size\":0,\"title\":\"Top Tables by Volume with Current Settings\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"TableName\",\"exportParameterName\":\"SelectedTable\",\"exportDefaultValue\":\"*\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"customWidth\":\"70\",\"name\":\"TopTablesList\",\"styleSettings\":{\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"## Table Tier and Retention Management\\r\\n\\r\\nSelect a table from the grid on the left to view and modify its settings. Click on a row to select a table for management.\",\"style\":\"info\"},\"customWidth\":\"30\",\"name\":\"InfoText\",\"styleSettings\":{\"showBorder\":true}},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"88df9a87-9c9f-4b69-a28a-3acd7b718e3a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectedTableName\",\"type\":1,\"isRequired\":true,\"value\":\"{SelectedTable}\",\"isHiddenWhenLocked\":true},{\"id\":\"c8ac5440-99f7-4a3d-8cb2-4a40d7056e68\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectedStorageTier\",\"label\":\"Storage Tier\",\"type\":2,\"isRequired\":true,\"multiSelect\":false,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"[\\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"Standard\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"Standard\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"Auxiliary\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"Auxiliary\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"Basic\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"Basic\\\\\\\"}\\\\r\\\\n]\\\",\\\"transformers\\\":[]}\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"defaultValue\":\"Standard\",\"queryType\":8},{\"id\":\"63af6414-8e0f-472a-9f2f-6d0a0bee198f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectedRetention\",\"label\":\"Retention Period (Days)\",\"type\":2,\"isRequired\":true,\"multiSelect\":false,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"[\\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"7\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"7 Days\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"14\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"14 Days\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"30\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"30 Days\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"60\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"60 Days\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"90\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"90 Days\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"120\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"120 Days\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"180\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"180 Days\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"365\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"365 Days\\\\\\\"}, \\\\r\\\\n    {\\\\\\\"value\\\\\\\":\\\\\\\"730\\\\\\\", \\\\\\\"label\\\\\\\":\\\\\\\"730 Days\\\\\\\"}\\\\r\\\\n]\\\",\\\"transformers\\\":[]}\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"defaultValue\":\"30\",\"queryType\":8}],\"style\":\"pills\",\"queryType\":0},\"conditionalVisibility\":{\"parameterName\":\"SelectedTable\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"customWidth\":\"70\",\"name\":\"TableSettingsParameters\"},{\"type\":12,\"content\":{\"version\":\"NotebookCell/1.0\",\"cellKind\":\"Code\",\"showBar\":true,\"executionHandler\":{\"name\":\"ParameterQuery\",\"options\":{\"parametersAllowDelivery\":true}},\"source\":{\"language\":\"javascript\",\"query\":\"let subscription = '${ subscription().subscriptionId }';\r\nlet resourceGroup = '${ resourceGroup().name }';\r\nlet workspace = '${ parameters('workspaceName') }';\r\nlet table = '${ SelectedTableName }';\r\nlet tier = '${ SelectedStorageTier }';\r\nlet retention = parseInt('${ SelectedRetention }');\r\n\r\n// Only execute if a table is selected and is not the default '*' value\r\nif (table && table !== '*') {\r\n    // Create the ARM template for updating the table\r\n    const armTemplate = {\r\n        properties: {\r\n            tier: tier,\r\n            retentionInDays: retention,\r\n            totalRetentionInDays: retention\r\n        }\r\n    };\r\n    \r\n    const armUrl = `https://management.azure.com/subscriptions/${subscription}/resourceGroups/${resourceGroup}/providers/Microsoft.OperationalInsights/workspaces/${workspace}/tables/${table}?api-version=2022-10-01`;\r\n\r\n    // Use the Azure Resource Graph API to update the table\r\n    const fetchOptions = {\r\n        method: 'PATCH',\r\n        headers: {\r\n            'Content-Type': 'application/json',\r\n            'Authorization': 'Bearer ' + window.athenaToken\r\n        },\r\n        body: JSON.stringify(armTemplate)\r\n    };\r\n\r\n    try {\r\n        const response = await fetch(armUrl, fetchOptions);\r\n        const data = await response.json();\r\n        \r\n        if (response.ok) {\r\n            return {\r\n                result: `Successfully updated table ${table} with tier: ${tier} and retention: ${retention} days`,\r\n                status: 'success'\r\n            };\r\n        } else {\r\n            return {\r\n                result: `Failed to update table: ${data.error?.message || 'Unknown error'}`,\r\n                status: 'failed'\r\n            };\r\n        }\r\n    } catch (error) {\r\n        return {\r\n            result: `Error updating table: ${error.message}`,\r\n            status: 'failed'\r\n        };\r\n    }\r\n} else {\r\n    return {\r\n        result: 'Please select a table first.',\r\n        status: 'info'\r\n    };\r\n}\r\n\"},\"id\":\"9c6beebc-cae9-46ac-9476-65f5a64ff7d7\",\"name\":\"UpdateTableTierScript\",\"underlyingType\":\"json\"},\"conditionalVisibility\":{\"parameterName\":\"SelectedTable\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"customWidth\":\"70\",\"name\":\"UpdateTableTierScript\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"0e71db8d-63b1-4659-9526-b1e232f4bc17\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"UpdateStatus\",\"type\":1,\"isRequired\":true,\"query\":\"let result = dynamic({UpdateTableTierScript});\\\"{result.status}\\\"\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":8,\"value\":\"\"},{\"id\":\"1073dada-ee63-459a-8db3-68d3a1fe6ab7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"UpdateMessage\",\"type\":1,\"isRequired\":true,\"query\":\"let result = dynamic({UpdateTableTierScript});\\\"{result.result}\\\"\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":8,\"value\":\"\"}],\"style\":\"pills\",\"queryType\":8},\"conditionalVisibility\":{\"parameterName\":\"UpdateTableTierScript\",\"comparison\":\"isNotEqualTo\",\"value\":\"\"},\"name\":\"UpdateStatusParameters\"},{\"type\":1,\"content\":{\"json\":\"### {UpdateMessage}\",\"style\":\"{UpdateStatus}\"},\"conditionalVisibility\":{\"parameterName\":\"UpdateStatus\",\"comparison\":\"isNotEqualTo\",\"value\":\"\"},\"customWidth\":\"70\",\"name\":\"UpdateResultText\"},{\"type\":1,\"content\":{\"json\":\"### Current Table: {SelectedTableName}\\r\\n\\r\\nUse the controls to modify the storage tier and retention period for this table. When you're satisfied with your selections, click the 'Apply Changes' button below.\\r\\n\\r\\nNote: Changes may take a few minutes to propagate through the system.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"SelectedTable\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"customWidth\":\"30\",\"name\":\"text - 4\",\"styleSettings\":{\"showBorder\":true}},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"nav\",\"links\":[{\"id\":\"2286e712-3e48-4805-823c-df0f2cbe9573\",\"linkTarget\":\"RefreshBlade\",\"linkLabel\":\"Apply Changes\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"icon\":\"Deploy\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTable\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"customWidth\":\"30\",\"name\":\"ApplyChangesButton\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Usage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| where DataType in ('AuditLogs', 'SigninLogs', 'NonInteractiveUserSignInLogs', 'ServicePrincipalSignInLogs', 'ManagedIdentitySignInLogs')\\r\\n| summarize TotalGBytes = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), DataType\\r\\n| render timechart\",\"size\":0,\"aggregation\":5,\"title\":\"Entra ID Log Ingestion\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"EntraIDLogs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Detailed analysis of NonInteractiveUserSignInLogs\\r\\nSigninLogs\\r\\n| where TimeGenerated > ago(7d)\\r\\n| where Category == 'NonInteractiveUserSignInLogs'\\r\\n| extend AppName = AppDisplayName\\r\\n| summarize SignInCount = count() by AppName, UserPrincipalName, bin(TimeGenerated, 1d)\\r\\n| order by SignInCount desc\\r\\n| summarize TotalSignIns = sum(SignInCount), AppsUsed = dcount(AppName) by UserPrincipalName\\r\\n| top 20 by TotalSignIns desc\",\"size\":0,\"aggregation\":5,\"title\":\"NonInteractive SignIn Analysis - Top Users\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"NonInteractiveSignInAnalysis\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Detailed analysis of NonInteractiveUserSignInLogs by application\\r\\nSigninLogs\\r\\n| where TimeGenerated > ago(7d)\\r\\n| where Category == 'NonInteractiveUserSignInLogs'\\r\\n| extend AppName = AppDisplayName\\r\\n| summarize SignInCount = count(), UserCount = dcount(UserPrincipalName) by AppName\\r\\n| top 20 by SignInCount desc\\r\\n| extend RecommendedTier = iff(SignInCount > 10000, 'Auxiliary', 'Standard')\\r\\n| extend FilteringRecommendation = case(\\r\\n    SignInCount > 100000, 'Consider filtering out completely', \\r\\n    SignInCount > 50000, 'Consider filtering by specific criteria',\\r\\n    SignInCount > 10000, 'Monitor for unusual patterns',\\r\\n    'No filtering needed'\\r\\n)\",\"size\":0,\"aggregation\":5,\"title\":\"NonInteractive SignIn Analysis - Top Applications\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"NonInteractiveSignInAnalysisByApp\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Savings summary by recommended tier changes\\r\\nUsage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| summarize TotalGB = sum(Quantity)/1000 by DataType\\r\\n| order by TotalGB desc\\r\\n| where TotalGB > 1  // Focus on tables with significant volume\\r\\n| join kind=leftouter (\\r\\n    workspace('${parameters('workspaceName')}').Tables\\r\\n    | where TableName != ''\\r\\n    | project TableName, Tier = iif(isempty(Tier), 'Standard', Tier), RetentionInDays\\r\\n) on $left.DataType == $right.TableName\\r\\n| extend RetentionInDays = iif(isempty(RetentionInDays), 30, RetentionInDays)\\r\\n| extend Tier = iif(isempty(Tier), 'Standard', Tier)\\r\\n| extend QueryFrequency = case(\\r\\n    DataType in ('SecurityAlert', 'SecurityIncident', 'SigninLogs', 'AuditLogs'), 'High',\\r\\n    DataType in ('AzureActivity', 'CommonSecurityLog', 'Event'), 'Medium',\\r\\n    'Low'\\r\\n)\\r\\n| extend SecurityValue = case(\\r\\n    DataType in ('SecurityAlert', 'SecurityIncident', 'SigninLogs', 'AuditLogs'), 'High',\\r\\n    DataType in ('AzureActivity', 'CommonSecurityLog', 'Event'), 'Medium',\\r\\n    'Low'\\r\\n)\\r\\n| extend RecommendedTier = case(\\r\\n    QueryFrequency == 'High' and SecurityValue == 'High', 'Standard',\\r\\n    SecurityValue == 'High' and QueryFrequency != 'High', 'Auxiliary',\\r\\n    QueryFrequency == 'Low', 'Basic',\\r\\n    'Auxiliary'\\r\\n)\\r\\n| extend CurrentPrice = case(\\r\\n    Tier == 'Standard', 4.00,\\r\\n    Tier == 'Auxiliary', 1.50,\\r\\n    Tier == 'Basic', 0.50,\\r\\n    4.00\\r\\n)\\r\\n| extend RecommendedPrice = case(\\r\\n    RecommendedTier == 'Standard', 4.00,\\r\\n    RecommendedTier == 'Auxiliary', 1.50,\\r\\n    RecommendedTier == 'Basic', 0.50,\\r\\n    4.00\\r\\n)\\r\\n| extend CurrentCost = TotalGB * CurrentPrice / 30 \\r\\n| extend RecommendedCost = TotalGB * RecommendedPrice / 30\\r\\n| extend MonthlySavings = CurrentCost - RecommendedCost\\r\\n| where MonthlySavings > 0 // Only include tables with potential savings\\r\\n| summarize TotalCurrentCost = sum(CurrentCost), TotalRecommendedCost = sum(RecommendedCost), TotalSavings = sum(MonthlySavings) by RecommendedTier\\r\\n| order by TotalSavings desc\",\"size\":0,\"title\":\"Potential Savings by Tier Changes\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"PotentialSavingsByTier\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Usage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| where DataType startswith 'Corelight'\\r\\n| summarize TotalGBytes = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), DataType\\r\\n| render timechart\",\"size\":0,\"aggregation\":5,\"title\":\"Corelight Data Ingestion\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"CorelightLogs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Detailed analysis of Corelight logs\\r\\nUsage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| where DataType startswith 'Corelight'\\r\\n| summarize TotalGB = sum(Quantity)/1000 by DataType\\r\\n| extend SecurityValue = case(\\r\\n    DataType in ('Corelight_DNS', 'Corelight_HTTP', 'Corelight_SSL'), 'High',\\r\\n    DataType in ('Corelight_Conn'), 'Medium',\\r\\n    'Low'\\r\\n)\\r\\n| extend RecommendedTier = case(\\r\\n    SecurityValue == 'High', 'Standard',\\r\\n    SecurityValue == 'Medium', 'Auxiliary',\\r\\n    'Basic'\\r\\n)\\r\\n| extend CurrentTier = case(\\r\\n    DataType in ('Corelight_DNS', 'Corelight_HTTP', 'Corelight_SSL'), 'Standard',\\r\\n    DataType in ('Corelight_Conn'), 'Auxiliary',\\r\\n    'Basic'\\r\\n)\\r\\n| extend SavingsOpportunity = case(\\r\\n    CurrentTier == 'Standard' and RecommendedTier == 'Auxiliary', 'Move to Auxiliary',\\r\\n    CurrentTier == 'Standard' and RecommendedTier == 'Basic', 'Move to Basic',\\r\\n    CurrentTier == 'Auxiliary' and RecommendedTier == 'Basic', 'Move to Basic',\\r\\n    'Appropriate tier'\\r\\n)\\r\\n| extend EstimatedMonthlySavings = case(\\r\\n    CurrentTier == 'Standard' and RecommendedTier == 'Auxiliary', TotalGB * 2.50,  // Est. difference between tiers\\r\\n    CurrentTier == 'Standard' and RecommendedTier == 'Basic', TotalGB * 3.50,\\r\\n    CurrentTier == 'Auxiliary' and RecommendedTier == 'Basic', TotalGB * 1.00,\\r\\n    0\\r\\n)\\r\\n| project DataType, TotalGB, SecurityValue, CurrentTier, RecommendedTier, SavingsOpportunity, EstimatedMonthlySavings\\r\\n| order by TotalGB desc\",\"size\":0,\"title\":\"Corelight Data Tiering Recommendations\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"CorelightDataTieringRecommendations\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Top tables by growth over previous month\\r\\nlet current = Usage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| summarize CurrentGB = sum(Quantity)/1000 by DataType;\\r\\n\\r\\nlet previous = Usage\\r\\n| where TimeGenerated between(ago(60d)..ago(30d))\\r\\n| where IsBillable == true\\r\\n| summarize PreviousGB = sum(Quantity)/1000 by DataType;\\r\\n\\r\\ncurrent | join kind=fullouter previous on DataType\\r\\n| extend CurrentGB = iif(isempty(CurrentGB), 0.0, CurrentGB)\\r\\n| extend PreviousGB = iif(isempty(PreviousGB), 0.0, PreviousGB)\\r\\n| extend GrowthGB = CurrentGB - PreviousGB\\r\\n| extend GrowthPercent = iif(PreviousGB == 0, 100, (CurrentGB - PreviousGB) * 100 / PreviousGB)\\r\\n| where GrowthPercent > 10 or GrowthGB > 10  // Focus on significant growth\\r\\n| extend GrowthCategory = case(\\r\\n    GrowthPercent > 100, 'Critical',\\r\\n    GrowthPercent > 50, 'High',\\r\\n    GrowthPercent > 25, 'Medium',\\r\\n    'Low'\\r\\n)\\r\\n| extend OptimizationRecommendation = case(\\r\\n    GrowthCategory == 'Critical', 'Urgent: Implement filtering or tiering',\\r\\n    GrowthCategory == 'High', 'Investigate growth cause and optimize',\\r\\n    GrowthCategory == 'Medium', 'Monitor for continued growth',\\r\\n    'No action needed'\\r\\n)\\r\\n| project DataType, CurrentGB, PreviousGB, GrowthGB, GrowthPercent, GrowthCategory, OptimizationRecommendation\\r\\n| order by GrowthPercent desc\",\"size\":0,\"title\":\"Top Tables by Growth (Month over Month)\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"TopTablesByGrowth\"},{\"type\":1,\"content\":{\"json\":\"## Tiering Recommendations for High-Volume Log Types\\r\\n\\r\\n### NonInteractive SignIn Logs\\r\\n\\r\\n1. **Move to Auxiliary Tier**: These logs generate high volume with lower security value for real-time analytics.\\r\\n2. **Filter by Application**: Identify and exclude service principals that generate high volumes but have minimal security value.\\r\\n3. **Implement DCRs**: Use Data Collection Rules to filter these logs before ingestion.\\r\\n4. **Retention Strategy**: Consider shorter retention periods (30 days) for these logs.\\r\\n\\r\\n### Corelight/Zeek Network Logs\\r\\n\\r\\n1. **Tiered Approach**:\\r\\n   - **Standard Tier**: Keep DNS, HTTP, and SSL logs for active security monitoring\\r\\n   - **Auxiliary Tier**: Move connection logs for less frequent querying\\r\\n   - **Basic Tier**: Move high-volume, low-value protocols for compliance only\\r\\n\\r\\n2. **Sampling Strategy**: For very high volume sources, consider implementing sampling at 1:10 or 1:100 ratio.\\r\\n\\r\\n3. **Specialized DCRs**: Create protocol-specific DCRs with custom filters.\\r\\n\\r\\n### Azure Activity Logs\\r\\n\\r\\n1. **Focused Collection**: Target critical subscriptions containing sensitive resources.\\r\\n2. **Filter by Operation**: Filter out read-only operations and focus on writes/modifications.\\r\\n\\r\\n### Cost Optimization Action Plan\\r\\n\\r\\n1. Review highest growth tables monthly\\r\\n2. Implement recommended tiering changes\\r\\n3. Create DCRs for filtering before ingestion\\r\\n4. Monitor query patterns to validate tier decisions\\r\\n\"},\"name\":\"TieringRecommendations\"}],\"styleSettings\":{},\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}"
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2018-11-30",
      "name": "[variables('managedIdentityName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[parameters('roleGuid')]",
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', variables('contributorRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2018-11-30').principalId]",
        "principalType": "ServicePrincipal"
      }
    },
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2022-04-01",
      "name": "[parameters('workbookName')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]": {}
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]",
        "[resourceId('Microsoft.Authorization/roleAssignments', parameters('roleGuid'))]"
      ],
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[variables('workbookContent')]",
        "category": "sentinel",
        "sourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[variables('workbookId')]"
    },
    "managedIdentityId": {
      "type": "string",
      "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]"
    }
  }
}
