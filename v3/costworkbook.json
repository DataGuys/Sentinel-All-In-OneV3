{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspaceName": {
            "type": "string",
            "metadata": {
                "description": "Name for the Log Analytics workspace"
            }
        },
        "location": {
            "type": "string",
            "metadata": {
                "description": "Location for all resources."
            }
        },
        "workbookName": {
            "type": "string",
            "defaultValue": "Sentinel-V3-Cost-Monitor",
            "metadata": {
                "description": "Name for the cost monitoring workbook"
            }
        },
        "workbookDisplayName": {
            "type": "string",
            "defaultValue": "Sentinel V3 Cost Optimization Dashboard",
            "metadata": {
                "description": "Display name for the cost monitoring workbook"
            }
        }
    },
    "variables": {
        "workbookId": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookName'))]",
        "workbookContent": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Microsoft Sentinel Cost Optimization Dashboard\\r\\n\\r\\nThis dashboard helps you monitor and optimize the costs associated with your Microsoft Sentinel deployment.\\r\\n\\r\\n\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"94c93e8c-b1b0-4bdf-901e-81b894c67b1d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":604800000},{\"durationMs\":2592000000}]}}],\"style\":\"pills\",\"queryType\":0},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Usage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| summarize TotalGBytes = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), Solution\\r\\n| render timechart\",\"size\":0,\"aggregation\":5,\"title\":\"Daily Ingestion Volume by Solution\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"DailyIngestionBySolution\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Usage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| summarize TotalGBytes = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), DataType\\r\\n| render timechart\",\"size\":0,\"aggregation\":5,\"title\":\"Daily Ingestion Volume by Data Type\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"DailyIngestionByDataType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Usage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| where DataType in ('AuditLogs', 'SigninLogs', 'NonInteractiveUserSignInLogs', 'ServicePrincipalSignInLogs', 'ManagedIdentitySignInLogs')\\r\\n| summarize TotalGBytes = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), DataType\\r\\n| render timechart\",\"size\":0,\"aggregation\":5,\"title\":\"Entra ID Log Ingestion\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"EntraIDLogs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Usage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| where DataType startswith 'Corelight'\\r\\n| summarize TotalGBytes = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), DataType\\r\\n| render timechart\",\"size\":0,\"aggregation\":5,\"title\":\"Corelight Data Ingestion\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"CorelightLogs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Cost projection based on current usage\\r\\nlet dailyAverage = Usage\\r\\n| where TimeGenerated > ago(7d)\\r\\n| where IsBillable == true\\r\\n| summarize AvgGBPerDay = sum(Quantity) / 1000 / 7;\\r\\nlet basePrice = 4.00; // Sample price per GB - replace with actual pricing for your tier\\r\\ndailyAverage\\r\\n| extend DailyCost = AvgGBPerDay * basePrice\\r\\n| extend MonthlyCost = DailyCost * 30\\r\\n| extend YearlyCost = MonthlyCost * 12\\r\\n| project AvgGBPerDay, DailyCost, MonthlyCost, YearlyCost\",\"size\":4,\"title\":\"Cost Projection\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"CostProjection\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Cost optimization recommendations\\r\\nUsage\\r\\n| where TimeGenerated > ago(30d)\\r\\n| where IsBillable == true\\r\\n| summarize TotalGB = sum(Quantity) / 1000 by DataType\\r\\n| top 10 by TotalGB desc\\r\\n| extend Recommendation = case(\\r\\n    DataType == 'NonInteractiveUserSignInLogs', 'Consider moving to Auxiliary tier. Implement filters for service principals.',\\r\\n    DataType startswith 'Corelight', 'Review collection settings. Consider sampling for high-volume Corelight sources.',\\r\\n    DataType == 'AzureActivity', 'Filter by criticality. Move non-security critical logs to Auxiliary tier.',\\r\\n    DataType == 'AuditLogs', 'Implement targeted collection rules instead of collecting all audit logs.',\\r\\n    'Review usage patterns and consider implementing filters')\\r\\n| project DataType, ['Total GB (30 days)'] = TotalGB, ['Optimization Recommendation'] = Recommendation\\r\\n| order by TotalGB desc\",\"size\":0,\"title\":\"Cost Optimization Recommendations\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"OptimizationRecommendations\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Tiered storage usage\\r\\nlet standardTier = Usage\\r\\n| where TimeGenerated > ago(7d)\\r\\n| where IsBillable == true\\r\\n| where isnotempty(Solution)\\r\\n| where Solution !contains 'LogManagement'\\r\\n| summarize StandardTierGB = sum(Quantity) / 1000;\\r\\n\\r\\nlet auxiliaryTier = Usage\\r\\n| where TimeGenerated > ago(7d)\\r\\n| where IsBillable == true\\r\\n| where DataType in ('NonInteractiveUserSignInLogs', 'ServicePrincipalSignInLogs')\\r\\n| summarize AuxiliaryTierGB = sum(Quantity) / 1000;\\r\\n\\r\\nlet basicTier = Usage\\r\\n| where TimeGenerated > ago(7d)\\r\\n| where IsBillable == true\\r\\n| where isnotempty(Solution)\\r\\n| where Solution contains 'LogManagement'\\r\\n| where DataType !in ('AuditLogs', 'SigninLogs')\\r\\n| summarize BasicTierGB = sum(Quantity) / 1000;\\r\\n\\r\\nstandardTier\\r\\n| extend AuxiliaryTierGB = toscalar(auxiliaryTier)\\r\\n| extend BasicTierGB = toscalar(basicTier)\\r\\n| extend TotalGB = StandardTierGB + AuxiliaryTierGB + BasicTierGB\\r\\n| extend StandardTierPercent = StandardTierGB * 100 / TotalGB\\r\\n| extend AuxiliaryTierPercent = AuxiliaryTierGB * 100 / TotalGB\\r\\n| extend BasicTierPercent = BasicTierGB * 100 / TotalGB\\r\\n| project StandardTierGB, StandardTierPercent, AuxiliaryTierGB, AuxiliaryTierPercent, BasicTierGB, BasicTierPercent, TotalGB\",\"size\":0,\"title\":\"Storage Tier Distribution\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/${subscription().subscriptionId}/resourceGroups/${resourceGroup().name}/providers/Microsoft.OperationalInsights/workspaces/${parameters('workspaceName')}\"]},\"name\":\"StorageTierDistribution\"}],\"styleSettings\":{},\"fromTemplateId\":\"sentinel-UserWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}"
    },
    "resources": [
        {
            "type": "Microsoft.Insights/workbooks",
            "apiVersion": "2022-04-01",
            "name": "[parameters('workbookName')]",
            "location": "[parameters('location')]",
            "kind": "shared",
            "properties": {
                "displayName": "[parameters('workbookDisplayName')]",
                "serializedData": "[variables('workbookContent')]",
                "category": "sentinel",
                "sourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            }
        }
    ],
    "outputs": {
        "workbookId": {
            "type": "string",
            "value": "[variables('workbookId')]"
        }
    }
}
